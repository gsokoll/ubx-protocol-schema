{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://example.com/ubx-messages.schema.json",
  "title": "UBX Protocol Message Definitions",
  "description": "Schema for defining u-blox UBX protocol messages to assist GNSS driver development. Supports u-blox 8/M8, F9, and later generations. Version 1.5 adds variant_aliases for backward-compatible lookup of consolidated multi-variant messages.",
  "type": "object",
  "properties": {
    "schema_version": {
      "type": "string",
      "description": "Version of this schema format (e.g., '1.1')"
    },
    "source_document": {
      "type": "object",
      "description": "Reference to the source u-blox documentation",
      "properties": {
        "filename": { "type": "string" },
        "title": { "type": "string" },
        "document_number": { 
          "type": "string",
          "description": "e.g., 'UBX-21023318', 'UBXDOC-963802114-13124'"
        },
        "receiver_generation": { 
          "type": "string",
          "description": "Receiver platform generation: M8, M9, M10, F9, F10, X20"
        },
        "firmware_type": { 
          "type": "string",
          "description": "Firmware type: SPG (Standard), HPG (High Precision), ADR (Auto Dead Reckoning), MDR (Marine DR), LAP (Lane Accurate), HPS (High Precision Timing), DBD (Dead Reckoning)"
        },
        "firmware_version": { 
          "type": "string",
          "description": "Firmware version number, e.g., '1.51', '5.30'"
        },
        "protocol_version": { 
          "type": "string",
          "description": "UBX protocol interface version, e.g., '27.50', '34.30'"
        }
      }
    },
    "enumerations": {
      "type": "object",
      "description": "Shared enumeration definitions referenced by multiple messages",
      "additionalProperties": {
        "$ref": "#/$defs/enumeration"
      }
    },
    "message_classes": {
      "type": "object",
      "description": "Message classes indexed by class ID (hex string)",
      "additionalProperties": {
        "$ref": "#/$defs/message_class"
      }
    },
    "messages": {
      "type": "array",
      "description": "All message definitions",
      "items": {
        "$ref": "#/$defs/message"
      }
    }
  },
  "required": ["schema_version", "messages"],

  "$defs": {
    "enumeration": {
      "type": "object",
      "description": "A named enumeration that can be referenced by fields",
      "properties": {
        "description": { "type": "string" },
        "underlying_type": {
          "type": "string",
          "description": "The UBX data type (U1, U2, etc.)"
        },
        "values": {
          "type": "object",
          "additionalProperties": {
            "type": "object",
            "properties": {
              "value": {
                "oneOf": [
                  { "type": "integer" },
                  { "type": "string", "pattern": "^0x[0-9a-fA-F]+$" }
                ]
              },
              "description": { "type": "string" }
            },
            "required": ["value"]
          }
        }
      },
      "required": ["values"]
    },

    "message_class": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string",
          "description": "Class name (e.g., 'ACK', 'CFG', 'NAV')"
        },
        "class_id": {
          "type": "string",
          "pattern": "^0x[0-9a-fA-F]{2}$",
          "description": "Class ID as hex (e.g., '0x05')"
        },
        "description": { "type": "string" }
      },
      "required": ["name", "class_id"]
    },

    "message": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string",
          "description": "Full message name (e.g., 'UBX-ACK-ACK')"
        },
        "class_id": {
          "type": "string",
          "pattern": "^0x[0-9a-fA-F]{2}$"
        },
        "message_id": {
          "type": "string",
          "pattern": "^0x[0-9a-fA-F]{2}$"
        },
        "description": {
          "type": "string",
          "description": "Short description of the message"
        },
        "comment": {
          "type": "string",
          "description": "Extended comments about message usage"
        },
        "message_type": {
          "type": "string",
          "enum": [
            "input",
            "output",
            "command",
            "set",
            "get",
            "get_set",
            "set_get",
            "set_polled",
            "poll_request",
            "polled",
            "polled_command_output",
            "periodic",
            "periodic_polled",
            "input_output"
          ],
          "description": "Direction and nature of the message"
        },
        "needs_ack": {
          "type": "boolean",
          "description": "Whether this message expects ACK/NAK response"
        },
        "supported_versions": {
          "$ref": "#/$defs/version_support",
          "description": "Protocol versions and product variants supporting this message"
        },
        "deprecated": {
          "$ref": "#/$defs/deprecation_info",
          "description": "Deprecation status and replacement information"
        },
        "variant_aliases": {
          "type": "array",
          "description": "Alternative names for this message (e.g., suffix-named variants like UBX-MGA-GPS-EPH). Enables backward-compatible lookup by legacy names.",
          "items": {
            "type": "string"
          }
        },
        "variants": {
          "type": "array",
          "description": "For messages with multiple payload formats (e.g., different versions or sub-types)",
          "items": {
            "$ref": "#/$defs/message_variant"
          }
        },
        "payload": {
          "$ref": "#/$defs/payload",
          "description": "Payload definition (use this OR variants, not both)"
        }
      },
      "required": ["name", "class_id", "message_id", "message_type"],
      "oneOf": [
        { "required": ["payload"] },
        { "required": ["variants"] },
        {
          "properties": {
            "payload": false,
            "variants": false
          },
          "description": "Message with no payload"
        }
      ]
    },

    "version_support": {
      "type": "object",
      "description": "Protocol version and product variant support information",
      "properties": {
        "protocol_versions": {
          "type": "array",
          "items": { "type": "integer" },
          "description": "List of protocol versions where message was found, as integers (version * 100, e.g., 2750 for 27.50)"
        },
        "min_protocol_version": {
          "type": "integer",
          "description": "Minimum protocol version where message was found (version * 100, e.g., 1800 for 18.00)"
        },
        "max_protocol_version": {
          "type": "integer",
          "description": "Maximum protocol version (version * 100), only set if message was discontinued"
        },
        "source_manuals": {
          "type": "array",
          "items": { "type": "string" },
          "description": "List of manual identifiers this message was extracted from"
        },
        "product_variants": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Required product variants (e.g., ['ADR', 'UDR', 'High Precision GNSS', 'Time & Frequency Sync'])"
        },
        "device_families": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Supported device families (e.g., ['u-blox 8', 'u-blox M8', 'u-blox F9'])"
        }
      }
    },

    "deprecation_info": {
      "type": "object",
      "description": "Information about deprecated messages",
      "properties": {
        "is_deprecated": {
          "type": "boolean",
          "description": "Whether this message is deprecated"
        },
        "since_version": {
          "type": "string",
          "description": "Protocol version when deprecation began"
        },
        "replacement": {
          "type": "string",
          "description": "Recommended replacement message or class (e.g., 'UBX-MGA messages')"
        },
        "note": {
          "type": "string",
          "description": "Additional deprecation notes"
        }
      },
      "required": ["is_deprecated"]
    },

    "message_variant": {
      "type": "object",
      "description": "A specific variant of a message (for multi-format messages)",
      "properties": {
        "name": {
          "type": "string",
          "description": "Variant name/identifier"
        },
        "description": { "type": "string" },
        "discriminator": {
          "type": "object",
          "description": "How to identify this variant when parsing",
          "properties": {
            "field": {
              "type": "string",
              "description": "Field name to check"
            },
            "byte_offset": {
              "type": "integer",
              "description": "Byte offset of discriminator field"
            },
            "value": {
              "oneOf": [
                { "type": "integer" },
                { "type": "string" }
              ],
              "description": "Expected value for this variant"
            },
            "payload_length": {
              "type": "integer",
              "description": "Alternative: discriminate by payload length"
            },
            "payload_length_range": {
              "type": "object",
              "description": "Alternative: discriminate by payload length range",
              "properties": {
                "min": { "type": "integer" },
                "max": { "type": ["integer", "null"] }
              }
            }
          }
        },
        "payload": {
          "$ref": "#/$defs/payload"
        }
      },
      "required": ["name", "payload"]
    },

    "payload": {
      "type": "object",
      "properties": {
        "length": {
          "$ref": "#/$defs/payload_length"
        },
        "fields": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/field"
          }
        },
        "repeated_groups": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/repeated_group"
          }
        },
        "optional_blocks": {
          "type": "array",
          "description": "Optional trailing blocks that may or may not be present",
          "items": {
            "$ref": "#/$defs/optional_block"
          }
        }
      },
      "required": ["length", "fields"]
    },

    "payload_length": {
      "oneOf": [
        {
          "type": "object",
          "properties": {
            "fixed": {
              "type": "integer",
              "description": "Fixed payload length in bytes"
            }
          },
          "required": ["fixed"],
          "additionalProperties": false
        },
        {
          "type": "object",
          "properties": {
            "variable": {
              "type": "object",
              "properties": {
                "base": {
                  "type": "integer",
                  "description": "Base (fixed) portion of payload"
                },
                "formula": {
                  "type": "string",
                  "description": "Human-readable formula (e.g., '8 + nPorts*40')"
                },
                "min": {
                  "type": "integer",
                  "description": "Minimum payload length"
                },
                "max": {
                  "type": ["integer", "null"],
                  "description": "Maximum payload length (null if unbounded)"
                }
              },
              "required": ["base"]
            }
          },
          "required": ["variable"],
          "additionalProperties": false
        },
        {
          "type": "object",
          "properties": {
            "alternatives": {
              "type": "array",
              "description": "Multiple valid fixed lengths (e.g., AID-ALM with 8 or 40 bytes)",
              "items": {
                "type": "integer"
              }
            }
          },
          "required": ["alternatives"],
          "additionalProperties": false
        }
      ]
    },

    "optional_block": {
      "type": "object",
      "description": "An optional block of fields that may or may not be present",
      "properties": {
        "name": {
          "type": "string",
          "description": "Identifier for this optional block"
        },
        "description": { "type": "string" },
        "base_offset": {
          "type": "integer",
          "description": "Byte offset where this block starts if present"
        },
        "size_bytes": {
          "type": "integer",
          "description": "Size of this optional block in bytes"
        },
        "presence_condition": {
          "type": "string",
          "description": "Condition for presence (e.g., 'payload_length > 8', 'week != 0')"
        },
        "fields": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/field"
          }
        }
      },
      "required": ["name", "base_offset", "fields"]
    },

    "field": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string",
          "description": "Field name (Rust-friendly identifier)"
        },
        "byte_offset": {
          "oneOf": [
            { "type": "integer" },
            {
              "type": "string",
              "description": "Formula for variable offset (e.g., '16 + n*4')"
            }
          ]
        },
        "data_type": {
          "$ref": "#/$defs/data_type"
        },
        "description": { "type": "string" },
        "scale": {
          "$ref": "#/$defs/scale_factor"
        },
        "unit": {
          "type": "string",
          "description": "Physical unit (e.g., 'deg', 'm', 's', 'mm/s')"
        },
        "reserved": {
          "type": "boolean",
          "description": "Whether this is a reserved field (should be ignored in output, zero in input)"
        },
        "opaque": {
          "type": "boolean",
          "description": "Whether this X-type field intentionally lacks bitfield definitions (hardware-specific or undocumented bit structure)"
        },
        "validity_flag": {
          "type": "string",
          "description": "Name of the flag field that indicates if this field is valid"
        },
        "enumeration": {
          "type": "string",
          "description": "Reference to a named enumeration in the enumerations section"
        },
        "inline_enum": {
          "$ref": "#/$defs/enumeration",
          "description": "Inline enumeration definition for this field only"
        },
        "bitfield": {
          "$ref": "#/$defs/bitfield",
          "description": "Bitfield definition if this is an X-type field"
        },
        "conditional_interpretation": {
          "$ref": "#/$defs/conditional_interpretation",
          "description": "For union-style fields whose meaning depends on flags"
        },
        "version_specific": {
          "$ref": "#/$defs/version_specific_field",
          "description": "Protocol version-specific overrides for fields that differ across versions"
        },
        "since_protocol_version": {
          "type": "integer",
          "description": "Protocol version (×100) when this field was introduced. Before this version, the bytes were reserved."
        },
        "prior_name": {
          "type": "string",
          "description": "Name of this field before it was defined (e.g., 'reserved4'). Used with since_protocol_version."
        }
      },
      "required": ["name", "byte_offset", "data_type"]
    },

    "version_specific_field": {
      "type": "object",
      "description": "Version-specific field attribute overrides. Keys are protocol version identifiers.",
      "additionalProperties": {
        "type": "object",
        "description": "Overrides for a specific protocol version",
        "properties": {
          "data_type": {
            "$ref": "#/$defs/data_type",
            "description": "Override data type for this version"
          },
          "byte_offset": {
            "type": "integer",
            "description": "Override byte offset for this version"
          },
          "size_bytes": {
            "type": "integer",
            "description": "Override size in bytes for this version"
          },
          "description": {
            "type": "string",
            "description": "Version-specific description"
          }
        }
      },
      "examples": [
        {
          "proto23": { "data_type": "X2", "size_bytes": 2 },
          "proto27": { "data_type": "X1", "size_bytes": 1 }
        }
      ]
    },

    "conditional_interpretation": {
      "type": "object",
      "description": "Field meaning that varies based on another field's value (union-style)",
      "properties": {
        "selector_field": {
          "type": "string",
          "description": "Field or bitfield flag that determines interpretation (e.g., 'flags.lla')"
        },
        "interpretations": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "when": {
                "type": "string",
                "description": "Condition expression (e.g., 'flags.lla == 1', 'flags.clockD == 1')"
              },
              "name": {
                "type": "string",
                "description": "Alternative field name for this interpretation"
              },
              "unit": {
                "type": "string",
                "description": "Physical unit for this interpretation"
              },
              "scale": {
                "$ref": "#/$defs/scale_factor"
              },
              "description": {
                "type": "string"
              }
            },
            "required": ["when", "description"]
          }
        }
      },
      "required": ["selector_field", "interpretations"]
    },

    "data_type": {
      "oneOf": [
        {
          "type": "string",
          "enum": [
            "U1", "I1", "X1",
            "U2", "I2", "X2",
            "U4", "I4", "X4",
            "R4", "R8",
            "I8",
            "CH",
            "RU1_3",
            "RU2_5"
          ],
          "description": "Scalar UBX data type"
        },
        {
          "type": "object",
          "description": "Array type",
          "properties": {
            "array_of": {
              "type": "string",
              "enum": [
                "U1", "I1", "X1",
                "U2", "I2", "X2",
                "U4", "I4", "X4",
                "R4", "R8",
                "I8",
                "CH"
              ]
            },
            "count": {
              "oneOf": [
                { "type": "integer" },
                { "type": "string", "description": "Field name that contains the count" }
              ]
            }
          },
          "required": ["array_of", "count"]
        }
      ]
    },

    "scale_factor": {
      "type": "object",
      "description": "Scale factor to convert raw integer to physical value",
      "properties": {
        "raw": {
          "type": "string",
          "description": "Original scale string from documentation (e.g., '2^-31', '1e-7')"
        },
        "multiplier": {
          "type": "number",
          "description": "Numeric multiplier (raw_value * multiplier = physical_value)"
        },
        "representation": {
          "type": "object",
          "description": "Structured representation for code generation",
          "properties": {
            "type": {
              "type": "string",
              "enum": ["power_of_2", "power_of_10", "fraction", "integer"]
            },
            "base": { "type": "integer" },
            "exponent": { "type": "integer" },
            "numerator": { "type": "integer" },
            "denominator": { "type": "integer" }
          }
        }
      },
      "required": ["raw", "multiplier"]
    },

    "bitfield": {
      "type": "object",
      "description": "Definition of bits within an X-type field",
      "properties": {
        "bits": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/bitfield_entry"
          }
        }
      },
      "required": ["bits"]
    },

    "bitfield_entry": {
      "type": "object",
      "properties": {
        "name": { "type": "string" },
        "bit_start": {
          "type": "integer",
          "description": "Starting bit position (0-indexed, LSB)"
        },
        "bit_end": {
          "type": "integer",
          "description": "Ending bit position (inclusive). Same as bit_start for single-bit flags"
        },
        "data_type": {
          "type": "string",
          "enum": ["U", "I", "S"],
          "description": "U=unsigned, I=signed two's complement, S=sign-magnitude"
        },
        "description": { "type": "string" },
        "enumeration": {
          "type": "string",
          "description": "Reference to named enumeration"
        },
        "inline_enum": {
          "$ref": "#/$defs/enumeration"
        },
        "reserved": {
          "type": "boolean"
        },
        "since_protocol_version": {
          "type": "integer",
          "description": "Protocol version (×100) when this bit/field was introduced. Before this version, the bit was reserved."
        },
        "prior_name": {
          "type": "string",
          "description": "Name of this bit before it was defined (e.g., 'reserved'). Used with since_protocol_version."
        }
      },
      "required": ["name", "bit_start", "bit_end", "data_type"]
    },

    "repeated_group": {
      "type": "object",
      "description": "A group of fields that repeats",
      "properties": {
        "name": {
          "type": "string",
          "description": "Identifier for this group (for Rust struct naming)"
        },
        "description": { "type": "string" },
        "repetition_type": {
          "type": "string",
          "enum": ["count_field", "constant", "optional", "fill_remaining"],
          "description": "How repetition count is determined"
        },
        "count_field": {
          "type": "string",
          "description": "Name of the field containing repetition count (for count_field type)"
        },
        "constant_count": {
          "type": "integer",
          "description": "Fixed number of repetitions (for constant type)"
        },
        "group_size_bytes": {
          "type": "integer",
          "description": "Size of one group instance in bytes"
        },
        "base_offset": {
          "oneOf": [
            { "type": "integer" },
            {
              "type": "object",
              "description": "Dynamic offset computed from field values",
              "properties": {
                "base": { "type": "integer", "description": "Fixed base offset" },
                "add_field_products": {
                  "type": "array",
                  "description": "Terms to add: sum of (field_value * multiplier)",
                  "items": {
                    "type": "object",
                    "properties": {
                      "field": { "type": "string", "description": "Name of the count field" },
                      "multiplier": { "type": "integer", "description": "Bytes per item" }
                    },
                    "required": ["field", "multiplier"]
                  }
                }
              },
              "required": ["base"]
            }
          ],
          "description": "Byte offset where the group starts (integer or dynamic formula)"
        },
        "fields": {
          "type": "array",
          "description": "Fields within one repetition of the group (offsets relative to group start)",
          "items": {
            "$ref": "#/$defs/field"
          }
        }
      },
      "required": ["name", "repetition_type", "group_size_bytes", "base_offset", "fields"]
    }
  }
}
